<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumalog</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background: #fff;
        color: #000;
        line-height: 1.5;
      }
      
      .container {
        display: flex;
        min-height: 100vh;
      }
      
      .sidebar {
        width: 240px;
        border-right: 1px solid #000;
        padding: 0;
        flex-shrink: 0;
      }
      
      .sidebar-header {
        padding: 30px 20px;
        border-bottom: 1px solid #000;
      }
      
      .logo-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 0;
      }
      
      .logo-img {
        height: 32px;
        width: auto;
      }
      
      .logo-text {
        font-size: 18px;
        font-weight: 400;
        letter-spacing: -0.02em;
      }
      
      .sidebar-inner {
        padding: 30px 20px;
      }
      
      .results-count {
        font-size: 14px;
        padding: 30px 20px 20px 20px;
        border-bottom: 1px solid #000;
        margin-bottom: 30px;
      }
      
      .filter-section {
        margin-bottom: 0;
        padding-bottom: 25px;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 25px;
      }
      
      .filter-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }
      
      .filter-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 12px;
        font-weight: 500;
      }
      
      .filter-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .filter-option {
        font-size: 14px;
        cursor: pointer;
        padding: 4px 0;
      }
      
      .filter-option.active {
        text-decoration: underline;
      }
      
      .search-input {
        width: 100%;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid #000;
        font-size: 14px;
        background: transparent;
      }
      
      .search-input:focus {
        outline: none;
      }
      
      .main-content {
        flex: 1;
        padding: 0;
      }
      
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 0;
        border-top: 1px solid #e0e0e0;
      }
      
      .product-card {
        cursor: pointer;
        border-right: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;
        padding: 20px;
      }
      
      .product-card:last-child {
        border-right: none;
      }
      
      .product-image-container {
        width: 100%;
        aspect-ratio: 1;
        background: #fff;
        margin-top: 10px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }
      
      .product-factory-badge {
        position: absolute;
        top: 0px;
        left: 0px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
        z-index: 10;
      }
      
      .product-image {
        max-width: 80%;
        max-height: 80%;
        object-fit: contain;
      }
      
      .product-info {
        font-size: 14px;
        line-height: 1.6;
      }
      
      .product-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1a1a1a;
      }
      
      .product-specs {
        color: #666;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0;
        margin-bottom: 4px;
      }
      
      .product-specs > span:not(:last-child)::after {
        content: "â€¢";
        margin: 0 8px;
        color: #999;
      }
      
      .product-meta {
        font-size: 12px;
        color: #999;
        font-family: monospace;
        margin-top: 8px;
      }
      
      .login-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 30px;
      }
      
      .login-logo {
        height: 64px;
        width: auto;
      }
      
      .login-title {
        font-size: 32px;
        font-weight: 300;
        letter-spacing: -0.02em;
      }
      
      .login-input {
        padding: 12px 0;
        border: none;
        border-bottom: 1px solid #000;
        font-size: 16px;
        width: 240px;
        text-align: center;
        background: transparent;
      }
      
      .login-input:focus {
        outline: none;
      }
      
      .login-btn {
        padding: 12px 40px;
        border: 1px solid #000;
        background: #000;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
      }
      
      .login-btn:hover {
        background: #fff;
        color: #000;
      }
      
      .loading-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CONFIG = {
          GOOGLE_SHEET_ID: '17loO452it-qoRcwNKp5nbZg0exuBRZt794sTOmrkwEY',
          PASSWORD: 'testck',
          IMAGE_BASE_URL: 'https://raw.githubusercontent.com/josephkimkuma/packaging_catalog/main/images',
          IMAGE_EXTENSION: '.png',
          FACTORY_FOLDERS: {
            'Taesung': 'taesung',
            'Kugil': 'kugil',
            'MYC': 'myc',
          },
          LOGO_URL: 'https://raw.githubusercontent.com/josephkimkuma/packaging_catalog/main/logo.png',
          SHEET_NAMES: ['Taesung', 'Kugil', 'MYC'],
        };

        const Kumalog = () => {
          const [products, setProducts] = useState([]);
          const [loading, setLoading] = useState(true);
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('all');
          const [selectedFactory, setSelectedFactory] = useState('all');
          const [selectedLocation, setSelectedLocation] = useState('all');
          const [selectedVolume, setSelectedVolume] = useState('all');
          const [selectedShape, setSelectedShape] = useState('all');
          const [selectedMaterial, setSelectedMaterial] = useState('all');
          const [darkMode, setDarkMode] = useState(false);

          useEffect(() => {
            const authTime = localStorage.getItem('authTime');
            if (authTime) {
              const hoursSinceAuth = (Date.now() - parseInt(authTime)) / (1000 * 60 * 60);
              if (hoursSinceAuth < 24) {
                setIsAuthenticated(true);
              } else {
                localStorage.removeItem('authTime');
              }
            }
          }, []);

          useEffect(() => {
            if (isAuthenticated) {
              fetchData();
            }
          }, [isAuthenticated]);

          const handleLogin = () => {
            if (password === CONFIG.PASSWORD) {
              setIsAuthenticated(true);
              localStorage.setItem('authTime', Date.now().toString());
            } else {
              alert('incorrect password');
              setPassword('');
            }
          };

          const fetchData = async () => {
            setLoading(true);
            try {
              const allProducts = [];
              
              for (const sheetName of CONFIG.SHEET_NAMES) {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
                console.log(`Fetching ${sheetName} data from:`, csvUrl);
                
                await new Promise((resolve, reject) => {
                  Papa.parse(csvUrl, {
                    download: true,
                    header: true,
                    complete: (results) => {
                      console.log(`${sheetName} loaded:`, results.data.length, 'rows');
                      const factoryProducts = results.data
                        .filter(row => row.itemNumber || row['Item Number'])
                        .map((row, index) => {
                          const itemNumber = row.itemNumber || row['Item Number'] || '';
                          const factory = row.factory || row['Factory'] || sheetName;
                          const folderName = CONFIG.FACTORY_FOLDERS[factory] || factory.toLowerCase();
                          const imageUrl = `${CONFIG.IMAGE_BASE_URL}/${folderName}/${itemNumber}${CONFIG.IMAGE_EXTENSION}`;
                          
                          return {
                            id: `${sheetName}-${index}`,
                            itemNumber: itemNumber,
                            name: row.name || row['Name'] || '',
                            category: row.category || row['Category'] || '',
                            factory: factory,
                            location: row.location || row['Location'] || '',
                            volume: row.volume || row['Volume'] || '',
                            shape: row.shape || row['Shape'] || '',
                            material: row.material || row['Material'] || '',
                            image: imageUrl
                          };
                        });
                      allProducts.push(...factoryProducts);
                      resolve();
                    },
                    error: (error) => {
                      console.error(`Error loading ${sheetName}:`, error);
                      reject(error);
                    }
                  });
                });
              }
              
              console.log('Total processed products:', allProducts.length);
              setProducts(allProducts);
              setLoading(false);
            } catch (error) {
              console.error('Error loading data:', error);
              alert('Error loading catalog data. Check console for details.');
              setLoading(false);
            }
          };

          const refreshData = () => {
            fetchData();
          };

          const toggleDarkMode = () => {
            setDarkMode(!darkMode);
            document.body.style.background = darkMode ? '#fff' : '#1a1a1a';
            document.body.style.color = darkMode ? '#000' : '#fff';
          };

          const categories = useMemo(() => {
            const uniqueCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
            return ['all', ...uniqueCategories.sort()];
          }, [products]);

          const factories = useMemo(() => {
            const uniqueFactories = [...new Set(products.map(p => p.factory).filter(Boolean))];
            return ['all', ...uniqueFactories.sort()];
          }, [products]);
          
          const extractUniqueValues = (field, sortNumerically = false) => {
            const allValues = products
              .flatMap(p => p[field]?.split(',').map(v => v.trim()) || [])
              .filter(Boolean);
            const uniqueValues = [...new Set(allValues)];
            
            if (sortNumerically) {
              uniqueValues.sort((a, b) => {
                const numA = parseFloat(a.match(/[\d.]+/)?.[0] || 0);
                const numB = parseFloat(b.match(/[\d.]+/)?.[0] || 0);
                return numA - numB;
              });
            } else {
              uniqueValues.sort((a, b) => a.localeCompare(b));
            }
            
            return ['all', ...uniqueValues];
          };
          
          const locations = extractUniqueValues('location');
          const volumes = extractUniqueValues('volume', true);
          const shapes = extractUniqueValues('shape');
          const materials = extractUniqueValues('material');

          const filteredProducts = useMemo(() => {
            return products.filter(product => {
              const matchesSearch = !searchTerm || 
                product.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.itemNumber?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.category?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.factory?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.location?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.volume?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.shape?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.material?.toLowerCase().includes(searchTerm.toLowerCase());
              
              const matchesCategory = selectedCategory === 'all' || product.category === selectedCategory;
              const matchesFactory = selectedFactory === 'all' || product.factory === selectedFactory;
              const matchesLocation = selectedLocation === 'all' || 
                product.location?.split(',').map(v => v.trim()).includes(selectedLocation);
              const matchesVolume = selectedVolume === 'all' || 
                product.volume?.split(',').map(v => v.trim()).includes(selectedVolume);
              const matchesShape = selectedShape === 'all' || 
                product.shape?.split(',').map(v => v.trim()).includes(selectedShape);
              const matchesMaterial = selectedMaterial === 'all' || 
                product.material?.split(',').map(v => v.trim()).includes(selectedMaterial);
              
              return matchesSearch && matchesCategory && matchesFactory && 
                     matchesLocation && matchesVolume && matchesShape && matchesMaterial;
            });
          }, [searchTerm, selectedCategory, selectedFactory, selectedLocation, 
              selectedVolume, selectedShape, selectedMaterial, products]);

          if (!isAuthenticated) {
            return (
              <div className="login-screen">
                {CONFIG.LOGO_URL && <img src={CONFIG.LOGO_URL} alt="Logo" className="login-logo" />}
                <div className="login-title">kumalog</div>
                <input
                  type="password"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  onKeyPress={e => e.key === 'Enter' && handleLogin()}
                  placeholder="password"
                  className="login-input"
                  autoFocus
                />
                <button onClick={handleLogin} className="login-btn">enter</button>
              </div>
            );
          }

          if (loading) {
            return <div className="loading-screen">loading...</div>;
          }

          return (
            <div className="container">
              <div className="sidebar">
                <div className="sidebar-header">
                  <div className="logo-container">
                    {CONFIG.LOGO_URL && <img 
                      src={CONFIG.LOGO_URL} 
                      alt="Logo" 
                      className="logo-img"
                      onError={(e) => {
                        console.error('Logo failed to load:', CONFIG.LOGO_URL);
                        e.target.style.display = 'none';
                      }}
                    />}
                    <div className="logo-text">kumalog</div>
                  </div>
                </div>
                
                <div className="results-count">{filteredProducts.length} results</div>
                
                <div className="sidebar-inner">
                  <div className="filter-section">
                    <input
                      type="text"
                      placeholder="search..."
                      value={searchTerm}
                      onChange={e => setSearchTerm(e.target.value)}
                      className="search-input"
                    />
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">category</div>
                    <div className="filter-options">
                      {categories.map(cat => (
                        <div
                          key={cat}
                          className={`filter-option ${selectedCategory === cat ? 'active' : ''}`}
                          onClick={() => setSelectedCategory(cat)}
                        >
                          {cat === 'all' ? 'all' : cat}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">factory</div>
                    <div className="filter-options">
                      {factories.map(fac => (
                        <div
                          key={fac}
                          className={`filter-option ${selectedFactory === fac ? 'active' : ''}`}
                          onClick={() => setSelectedFactory(fac)}
                        >
                          {fac === 'all' ? 'all' : fac}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">location</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {locations.map(loc => (
                        <div
                          key={loc}
                          className={`filter-option ${selectedLocation === loc ? 'active' : ''}`}
                          onClick={() => setSelectedLocation(loc)}
                        >
                          {loc === 'all' ? 'all' : loc}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">volume</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {volumes.map(vol => (
                        <div
                          key={vol}
                          className={`filter-option ${selectedVolume === vol ? 'active' : ''}`}
                          onClick={() => setSelectedVolume(vol)}
                        >
                          {vol === 'all' ? 'all' : vol}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">shape</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {shapes.map(shp => (
                        <div
                          key={shp}
                          className={`filter-option ${selectedShape === shp ? 'active' : ''}`}
                          onClick={() => setSelectedShape(shp)}
                        >
                          {shp === 'all' ? 'all' : shp}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">material</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {materials.map(mat => (
                        <div
                          key={mat}
                          className={`filter-option ${selectedMaterial === mat ? 'active' : ''}`}
                          onClick={() => setSelectedMaterial(mat)}
                        >
                          {mat === 'all' ? 'all' : mat}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              <div className="main-content">
                <div className="product-grid">
                  {filteredProducts.map(p => (
                    <div key={p.id} className="product-card">
                      <div className="product-image-container">
                        {p.factory && <div className="product-factory-badge">{p.factory}</div>}
                        <img
                          src={p.image}
                          alt={p.name}
                          className="product-image"
                          onError={e => e.target.src = 'https://via.placeholder.com/400?text=No+Image'}
                        />
                      </div>
                      <div className="product-info">
                        <div className="product-title">{p.itemNumber}</div>
                        <div className="product-specs">
                          {p.name && <span>{p.name}</span>}
                          {p.volume && <span>{p.volume}</span>}
                          {p.location && <span>{p.location}</span>}
                        </div>
                        {p.category && (
                          <div className="product-meta">{p.category}</div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<Kumalog />, document.getElementById('root'));
    </script>
</body>
</html>
