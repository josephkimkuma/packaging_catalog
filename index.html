<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumalog</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background: #fff;
        color: #000;
        line-height: 1.5;
      }
      
      .header {
        padding: 20px 40px;
        border-bottom: 1px solid #000;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .logo-container {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .logo-img {
        height: 32px;
        width: auto;
      }
      
      .logo-text {
        font-size: 18px;
        font-weight: 400;
        letter-spacing: -0.02em;
      }
      
      .header-controls {
        display: flex;
        gap: 20px;
        font-size: 14px;
      }
      
      .header-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        font-size: 14px;
        text-decoration: underline;
      }
      
      .container {
        display: flex;
        min-height: calc(100vh - 61px);
      }
      
      .sidebar {
        width: 240px;
        border-right: 1px solid #000;
        padding: 0;
        flex-shrink: 0;
      }
      
      .sidebar-inner {
        padding: 30px 20px;
      }
      
      .results-count {
        font-size: 14px;
        padding: 30px 20px 20px 20px;
        border-bottom: 1px solid #000;
        margin-bottom: 30px;
      }
      
      .filter-section {
        margin-bottom: 0;
        padding-bottom: 25px;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 25px;
      }
      
      .filter-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }
      
      .filter-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 12px;
        font-weight: 500;
      }
      
      .filter-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .filter-option {
        font-size: 14px;
        cursor: pointer;
        padding: 4px 0;
      }
      
      .filter-option.active {
        text-decoration: underline;
      }
      
      .search-input {
        width: 100%;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid #000;
        font-size: 14px;
        background: transparent;
      }
      
      .search-input:focus {
        outline: none;
      }
      
      .main-content {
        flex: 1;
        padding: 0;
      }
      
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 0;
        border-top: 1px solid #e0e0e0;
      }
      
      .product-card {
        cursor: pointer;
        border-right: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;
        padding: 20px;
      }
      
      .product-card:last-child {
        border-right: none;
      }
      
      .product-image-container {
        width: 100%;
        aspect-ratio: 1;
        background: #fff;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      
      .product-image {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
      }
      
      .product-info {
        font-size: 13px;
        line-height: 1.6;
      }
      
      .product-title {
        font-weight: 500;
        margin-bottom: 2px;
      }
      
      .product-subtitle {
        color: #666;
        margin-bottom: 8px;
      }
      
      .product-meta {
        font-size: 12px;
        color: #999;
        font-family: monospace;
      }
      
      .login-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 30px;
      }
      
      .login-logo {
        height: 64px;
        width: auto;
      }
      
      .login-title {
        font-size: 24px;
        font-weight: 400;
        letter-spacing: -0.02em;
      }
      
      .login-input {
        width: 300px;
        padding: 12px 0;
        border: none;
        border-bottom: 1px solid #000;
        font-size: 16px;
        text-align: center;
        background: transparent;
      }
      
      .login-input:focus {
        outline: none;
      }
      
      .login-btn {
        background: #000;
        color: #fff;
        border: none;
        padding: 12px 40px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 10px;
      }
      
      .loading-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }
      
      /* Dark mode */
      body.dark {
        background: #000;
        color: #fff;
      }
      
      .dark .header {
        border-bottom-color: #fff;
      }
      
      .dark .sidebar {
        border-right-color: #fff;
      }
      
      .dark .results-count {
        border-bottom-color: #fff;
      }
      
      .dark .filter-section {
        border-bottom-color: #333;
      }
      
      .dark .search-input,
      .dark .login-input {
        border-bottom-color: #fff;
        color: #fff;
      }
      
      .dark .product-image-container {
        background: #1a1a1a;
      }
      
      .dark .product-card {
        border-right-color: #333;
        border-bottom-color: #333;
      }
      
      .dark .product-grid {
        border-top-color: #333;
      }
      
      .dark .product-subtitle {
        color: #999;
      }
      
      .dark .product-meta {
        color: #666;
      }
      
      .dark .login-btn {
        background: #fff;
        color: #000;
      }
      
      .dark .logo-img {
        filter: invert(1);
      }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        const CONFIG = {
          GOOGLE_SHEET_ID: '17loO452it-qoRcwNKp5nbZg0exuBRZt794sTOmrkwEY',
          PASSWORD: 'testck',
          IMAGE_BASE_URL: 'https://raw.githubusercontent.com/josephkimkuma/packaging_catalog/main/images',
          IMAGE_EXTENSION: '.png',
          FACTORY_FOLDERS: {
            'Taesung': 'taesung',
            'Kugil': 'kugil',
            'MYC': 'myc',
          },
          LOGO_URL: 'https://raw.githubusercontent.com/josephkimkuma/packaging_catalog/main/logo.png',
          SHEET_NAMES: ['Taesung', 'Kugil', 'MYC'],
        };
        
        const Kumalog = () => {
          const [isAuthenticated, setIsAuthenticated] = useState(() => {
            const authTime = localStorage.getItem('authTime');
            if (authTime) {
              const hoursSinceAuth = (Date.now() - parseInt(authTime)) / (1000 * 60 * 60);
              return hoursSinceAuth < 1;
            }
            return false;
          });
          const [password, setPassword] = useState('');
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('all');
          const [selectedFactory, setSelectedFactory] = useState('all');
          const [selectedLocation, setSelectedLocation] = useState('all');
          const [selectedVolume, setSelectedVolume] = useState('all');
          const [selectedShape, setSelectedShape] = useState('all');
          const [selectedMaterial, setSelectedMaterial] = useState('all');
          const [products, setProducts] = useState([]);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState('');
          const [darkMode, setDarkMode] = useState(() => {
            const saved = localStorage.getItem('darkMode');
            return saved === 'true';
          });

          useEffect(() => {
            if (darkMode) {
              document.body.classList.add('dark');
            } else {
              document.body.classList.remove('dark');
            }
          }, [darkMode]);

          useEffect(() => {
            const loadProductsFromSheet = async () => {
              if (!isAuthenticated) return;
              
              try {
                setLoading(true);
                setError('');
                
                let allProducts = [];
                
                for (const sheetName of CONFIG.SHEET_NAMES) {
                  try {
                    const sheetUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
                    
                    const response = await fetch(sheetUrl);
                    if (!response.ok) continue;
                    
                    const csvText = await response.text();
                    
                    await new Promise((resolve) => {
                      Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                          const parsedProducts = results.data.map((row, index) => {
                            const itemNumber = row['Item #'] || row['Item#'] || '';
                            const factoryName = row['Factory name'] || row['Factory Name'] || '';
                            const category = row['Category'] || '';
                            const component = row['Component'] || '';
                            const fillVolume = row['Fill volume'] || row['Fill Volume'] || '';
                            const factoryLocation = row['Factory location'] || '';
                            const shape = row['Shape'] || '';
                            const material = row['Material'] || '';
                            const imageValue = row['Image'] || '';
                            
                            const factoryFolder = CONFIG.FACTORY_FOLDERS[factoryName] || CONFIG.FACTORY_FOLDERS[factoryName.trim()] || 'default';
                            const imageUrl = imageValue || `${CONFIG.IMAGE_BASE_URL}/${factoryFolder}/${itemNumber}${CONFIG.IMAGE_EXTENSION}`;
                            
                            return {
                              id: `${sheetName}-${itemNumber || index}`,
                              itemNumber,
                              name: component,
                              category,
                              factory: factoryName,
                              volume: fillVolume,
                              location: factoryLocation,
                              shape,
                              material,
                              image: imageUrl,
                              sourceSheet: sheetName
                            };
                          }).filter(p => p.itemNumber);
                          
                          allProducts = [...allProducts, ...parsedProducts];
                          resolve();
                        },
                        error: () => resolve()
                      });
                    });
                  } catch (err) {
                    console.warn(`Error loading sheet ${sheetName}:`, err);
                  }
                }
                
                setProducts(allProducts);
                setError('');
              } catch (err) {
                setError(err.message);
                setProducts([]);
              } finally {
                setLoading(false);
              }
            };

            if (isAuthenticated) loadProductsFromSheet();
          }, [isAuthenticated]);

          const handleLogin = () => {
            if (password.trim() === CONFIG.PASSWORD) {
              setIsAuthenticated(true);
              localStorage.setItem('authTime', Date.now().toString());
              setPassword('');
            } else {
              alert('Incorrect password');
              setPassword('');
            }
          };

          const toggleDarkMode = () => {
            const newMode = !darkMode;
            setDarkMode(newMode);
            localStorage.setItem('darkMode', newMode.toString());
          };

          const refreshData = () => {
            setIsAuthenticated(false);
            setTimeout(() => setIsAuthenticated(true), 100);
          };

          const categories = ['all', ...new Set(products.map(p => p.category).filter(Boolean))].sort();
          const factories = ['all', ...new Set(products.map(p => p.factory).filter(Boolean))].sort();
          
          const extractUniqueValues = (field, sortNumerically = false) => {
            const allValues = products
              .map(p => p[field])
              .filter(Boolean)
              .flatMap(val => val.split(',').map(v => v.trim()))
              .filter(Boolean);
            
            const uniqueValues = [...new Set(allValues)];
            
            if (sortNumerically) {
              uniqueValues.sort((a, b) => {
                const numA = parseFloat(a.match(/[\d.]+/)?.[0] || 0);
                const numB = parseFloat(b.match(/[\d.]+/)?.[0] || 0);
                return numA - numB;
              });
            } else {
              uniqueValues.sort((a, b) => a.localeCompare(b));
            }
            
            return ['all', ...uniqueValues];
          };
          
          const locations = extractUniqueValues('location');
          const volumes = extractUniqueValues('volume', true);
          const shapes = extractUniqueValues('shape');
          const materials = extractUniqueValues('material');

          const filteredProducts = useMemo(() => {
            return products.filter(product => {
              const matchesSearch = !searchTerm || 
                product.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.itemNumber?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.category?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.factory?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.location?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.volume?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.shape?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.material?.toLowerCase().includes(searchTerm.toLowerCase());
              
              const matchesCategory = selectedCategory === 'all' || product.category === selectedCategory;
              const matchesFactory = selectedFactory === 'all' || product.factory === selectedFactory;
              const matchesLocation = selectedLocation === 'all' || 
                product.location?.split(',').map(v => v.trim()).includes(selectedLocation);
              const matchesVolume = selectedVolume === 'all' || 
                product.volume?.split(',').map(v => v.trim()).includes(selectedVolume);
              const matchesShape = selectedShape === 'all' || 
                product.shape?.split(',').map(v => v.trim()).includes(selectedShape);
              const matchesMaterial = selectedMaterial === 'all' || 
                product.material?.split(',').map(v => v.trim()).includes(selectedMaterial);
              
              return matchesSearch && matchesCategory && matchesFactory && 
                     matchesLocation && matchesVolume && matchesShape && matchesMaterial;
            });
          }, [searchTerm, selectedCategory, selectedFactory, selectedLocation, 
              selectedVolume, selectedShape, selectedMaterial, products]);

          if (!isAuthenticated) {
            return (
              <div className="login-screen">
                {CONFIG.LOGO_URL && <img src={CONFIG.LOGO_URL} alt="Logo" className="login-logo" />}
                <div className="login-title">kumalog</div>
                <input
                  type="password"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  onKeyPress={e => e.key === 'Enter' && handleLogin()}
                  placeholder="password"
                  className="login-input"
                  autoFocus
                />
                <button onClick={handleLogin} className="login-btn">enter</button>
              </div>
            );
          }

          if (loading) {
            return <div className="loading-screen">loading...</div>;
          }

          return (
            <div>
              <div className="header">
                <div className="logo-container">
                  {CONFIG.LOGO_URL && <img src={CONFIG.LOGO_URL} alt="Logo" className="logo-img" />}
                  <div className="logo-text">kumalog</div>
                </div>
                <div className="header-controls">
                  <button onClick={toggleDarkMode} className="header-btn">
                    {darkMode ? 'light' : 'dark'}
                  </button>
                  <button onClick={refreshData} className="header-btn">refresh</button>
                  <button onClick={() => {
                    setIsAuthenticated(false);
                    localStorage.removeItem('authTime');
                  }} className="header-btn">logout</button>
                </div>
              </div>

              <div className="container">
                <div className="sidebar">
                  <div className="results-count">{filteredProducts.length} results</div>
                  <div className="sidebar-inner">
                    <div className="filter-section">
                    <input
                      type="text"
                      placeholder="search..."
                      value={searchTerm}
                      onChange={e => setSearchTerm(e.target.value)}
                      className="search-input"
                    />
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">category</div>
                    <div className="filter-options">
                      {categories.map(cat => (
                        <div
                          key={cat}
                          className={`filter-option ${selectedCategory === cat ? 'active' : ''}`}
                          onClick={() => setSelectedCategory(cat)}
                        >
                          {cat === 'all' ? 'all' : cat}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">factory</div>
                    <div className="filter-options">
                      {factories.map(fac => (
                        <div
                          key={fac}
                          className={`filter-option ${selectedFactory === fac ? 'active' : ''}`}
                          onClick={() => setSelectedFactory(fac)}
                        >
                          {fac === 'all' ? 'all' : fac}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">location</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {locations.map(loc => (
                        <div
                          key={loc}
                          className={`filter-option ${selectedLocation === loc ? 'active' : ''}`}
                          onClick={() => setSelectedLocation(loc)}
                        >
                          {loc === 'all' ? 'all' : loc}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">volume</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {volumes.map(vol => (
                        <div
                          key={vol}
                          className={`filter-option ${selectedVolume === vol ? 'active' : ''}`}
                          onClick={() => setSelectedVolume(vol)}
                        >
                          {vol === 'all' ? 'all' : vol}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">shape</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {shapes.map(shp => (
                        <div
                          key={shp}
                          className={`filter-option ${selectedShape === shp ? 'active' : ''}`}
                          onClick={() => setSelectedShape(shp)}
                        >
                          {shp === 'all' ? 'all' : shp}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="filter-section">
                    <div className="filter-title">material</div>
                    <div className="filter-options" style={{maxHeight: '150px', overflowY: 'auto'}}>
                      {materials.map(mat => (
                        <div
                          key={mat}
                          className={`filter-option ${selectedMaterial === mat ? 'active' : ''}`}
                          onClick={() => setSelectedMaterial(mat)}
                        >
                          {mat === 'all' ? 'all' : mat}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

                <div className="main-content">

                  <div className="product-grid">
                    {filteredProducts.map(p => (
                      <div key={p.id} className="product-card">
                        <div className="product-image-container">
                          <img
                            src={p.image}
                            alt={p.name}
                            className="product-image"
                            onError={e => e.target.src = 'https://via.placeholder.com/400?text=No+Image'}
                          />
                        </div>
                        <div className="product-info">
                          <div className="product-title">{p.itemNumber}</div>
                          <div className="product-subtitle">{p.name}</div>
                          <div className="product-meta">
                            {p.category && <div>{p.category}</div>}
                            {p.factory && <div>{p.factory}</div>}
                            {p.location && <div>{p.location}</div>}
                            {p.volume && <div>{p.volume}</div>}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<Kumalog />, document.getElementById('root'));
    </script>
</body>
</html>
